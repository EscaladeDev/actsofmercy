<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Aurora Library</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>

<style>
/* --- THEME & LAYOUT --- */
:root{--bg:#0b1020;--panel:#0f1428;--panel2:#0c1224;--text:#f7f8fb;--muted:#9aa3c2;--accent:#22c55e;--border:rgba(148,163,184,.35)}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,sans-serif;height:100vh;display:flex;flex-direction:column;overflow:hidden;}

/* HEADER */
header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:var(--panel);border-bottom:1px solid var(--border);z-index:20;flex-shrink:0;}
.brand{display:flex;gap:10px;align-items:center}
.logo{width:32px;height:32px;border-radius:8px;background:radial-gradient(circle at 35% 25%,#34d399,#059669 60%,#065f46 100%);display:grid;place-items:center;font-size:18px}
h1{font-size:16px;margin:0}
.pill{border:1px solid var(--border);padding:4px 10px;border-radius:999px;color:#d3d7e4;font-size:12px; transition: color 0.3s;}
.muted{color:var(--muted)}

/* MAP CONTAINER */
#map-container { flex: 1; position: relative; width: 100%; background: #0b1020; z-index: 1; }
#map-container::after {
    content: ''; position: absolute; inset: 0; pointer-events: none; z-index: 401;
    background: radial-gradient(circle at center, transparent 50%, #0b1020 100%);
    box-shadow: inset 0 0 40px #0b1020;
}
#map { width: 100%; height: 100%; background: #0b1020; outline: none; }

/* MARKERS & POPUPS */
.book-marker {
    background: var(--accent); border: 2px solid #fff; border-radius: 50%;
    box-shadow: 0 0 15px var(--accent), 0 0 30px var(--accent); transition: transform 0.2s ease;
}
.book-marker:hover { transform: scale(1.3); cursor: pointer; }

.leaflet-bar { border: none !important; box-shadow: 0 4px 12px rgba(0,0,0,0.5) !important; }
.leaflet-bar a { background: var(--panel2) !important; color: var(--text) !important; border-bottom: 1px solid var(--border) !important; }
.leaflet-bar a:hover { background: var(--panel) !important; color: var(--accent) !important; }
.leaflet-bar a:last-child { border-bottom: none !important; }

.leaflet-popup-content-wrapper, .leaflet-popup-tip {
    background: rgba(12, 18, 36, 0.95) !important; backdrop-filter: blur(8px);
    border: 1px solid var(--border); color: var(--text); border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.6);
}
.leaflet-popup-content { margin: 12px; line-height: 1.5; }
.leaflet-container a.leaflet-popup-close-button { color: var(--muted) !important; padding: 8px; }

.pop-meta { display: flex; flex-direction: column; gap: 4px; min-width: 180px; }
.pop-title { font-weight: 700; font-size: 15px; }
.pop-loc { color: var(--muted); font-size: 12px; display:flex; gap:4px; align-items:center; }
.pop-btn { margin-top: 10px; width: 100%; border:none; background:linear-gradient(#39d88a,#19964e); color:white; padding:8px; border-radius:6px; cursor:pointer; font-weight:600; }
.pop-btn:hover { opacity: 0.9; }
</style>
</head>
<body>

  <header>
    <div class="brand">
      <div class="logo" aria-hidden="true">üåç</div>
      <div>
        <h1>Aurora Atlas</h1>
        <div class="muted" style="font-size:12px">Spatial Library Browser</div>
      </div>
    </div>
    <span class="pill" id="libCount">Loading...</span>
  </header>

  <div id="map-container">
    <div id="map"></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

  <script>
  // --- 1. YOUR LIBRARY DATA ---
  const LIBRARY_DATA = [
    {
      file: "moby-dick.epub",
      name: "Moby Dick",
      lat: -37.8136, 
      lng: 144.9631,
      locationName: "Pacific Ocean (near Australia)"
    },
    {
      file: "sherlock.pdf",
      name: "Sherlock Holmes",
      lat: 51.5237, 
      lng: -0.1585,
      locationName: "London, UK"
    },
    {
      file: "Test.epub",
      name: "Test",
      lat: 40.7831, 
      lng: -73.9712,
      locationName: "New York, USA"
    }
  ];

  // --- 2. APP LOGIC ---
  const countEl = document.getElementById('libCount');
  const BOOKMARK_KEY = 'auroraReaderBookmarks_v1';
  let map = null;

  // Global Error Handler to catch hidden crashes
  window.onerror = function(msg, url, line) {
     console.error(msg);
     countEl.textContent = "Error (See Console)";
     countEl.style.color = "#ff4444";
     countEl.style.borderColor = "#ff4444";
     return false;
  };

  function loadBookmarks(){ 
    try{return JSON.parse(localStorage.getItem(BOOKMARK_KEY)||'{}')}catch(e){return{}} 
  }

  function labelFor(bm){
    if(!bm) return null;
    if(bm.mode==='epub'){
      const parts=bm.unitId.split('-'); const n=parseInt(parts[parts.length-1],10);
      return isNaN(n)?'Resume reading':'Resume Ch. '+(n+1);
    }
    return 'Resume reading';
  }

  function createPopupContent(book, resumeLabel){
    const div = document.createElement('div');
    div.className = 'pop-meta';
    const typeBadge = (book.file||'').endsWith('.pdf') ? 'PDF' : 'EPUB';
    
    div.innerHTML = `
      <div class="pop-title">${book.name}</div>
      <div class="pop-loc">üìç ${book.locationName}</div>
      <div style="font-size:11px; color:#9aa3c2; margin-top:2px">
        ${typeBadge} ‚Ä¢ ${resumeLabel || 'Not started'}
      </div>
      <button class="pop-btn">Open Book</button>
    `;
    div.querySelector('button').onclick = () => {
      const params = new URLSearchParams({file:book.file, name:book.name});
      location.href = './reader.html?'+params.toString();
    };
    return div;
  }

  function initMap(){
    // Check if Leaflet loaded
    if(typeof L === 'undefined'){
      countEl.textContent = "Map Error: No Internet?";
      countEl.style.color = "orange";
      return;
    }

    // Initialize Map
    map = L.map('map', { zoomControl: false, attributionControl: false }).setView([20, 0], 2);
    L.control.zoom({ position: 'bottomright' }).addTo(map);

    // Dark Tiles
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      maxZoom: 18,
      attribution: 'Map data &copy; OpenStreetMap'
    }).addTo(map);

    // Load Bookmarks
    const marks = loadBookmarks();
    const markers = [];

    // Icon Style
    const auroraIcon = L.divIcon({
      className: 'book-marker',
      iconSize: [12, 12],
      iconAnchor: [6, 6],
      popupAnchor: [0, -10]
    });

    // Place Markers from LIBRARY_DATA
    LIBRARY_DATA.forEach(book => {
      // Safety check for missing coords
      if(book.lat === undefined || book.lng === undefined) return;

      const resumeLabel = labelFor(marks[book.file] || marks[book.name]);
      const marker = L.marker([book.lat, book.lng], { icon: auroraIcon }).addTo(map);
      marker.bindPopup(createPopupContent(book, resumeLabel));
      markers.push(marker);
    });

    // Update Status
    if(markers.length > 0){
      countEl.textContent = markers.length + " locations mapped";
      const group = new L.featureGroup(markers);
      map.fitBounds(group.getBounds().pad(0.2));
    } else {
      countEl.textContent = "0 locations found";
    }
  }

  // Run when page is ready
  window.addEventListener('DOMContentLoaded', initMap);
  </script>
</body>
</html>